<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Redirection selon groupe</title>
  <script src="https://js.arcgis.com/4.33/"></script>
  <style>
    body { font-family: sans-serif; padding: 2em; }
  </style>
</head>
<body>
  <p>Chargement... Veuillez patienter.</p>

  <script>
    function waitForRequire(callback, timeout = 5000) {
      const start = Date.now();
      const interval = setInterval(() => {
        if (typeof require === "function") {
          clearInterval(interval);
          callback();
        } else if (Date.now() - start > timeout) {
          clearInterval(interval);
          document.body.innerHTML = "Erreur : l'API ArcGIS n'a pas pu être chargée.";
        }
      }, 100);
    }

    waitForRequire(() => {
      require(["esri/portal/Portal"], function(Portal) {
        const portal = new Portal({
          url: "https://donneesgeomatique.dev.montreal.ca/portal"
        });

        portal.load().then(() => {
        const user = portal.user;
        user.fetchGroups().then((groups) => {
        const groupTitles = groups.map(g => g.title);


          if (groupTitles.includes("Créateur")) {
            window.location.href = "https://donneesgeomatique.dev.montreal.ca/portal";
          } else if (groupTitles.includes("Éditeur")) {
            window.location.href = "https://donneesgeomatique.dev.montreal.ca/portal";
          } else if (groupTitles.includes("Lecteur")) {
            window.location.href = "https://donneesgeomatique.dev.montreal.ca/portal";
          } else {
            document.body.innerHTML = "Aucun accès défini pour votre groupe.";
          }
        });
        }).catch(error => {
          document.body.innerHTML = "Erreur lors du chargement du portail : " + error.message;
        });
      });
    });
  </script>
</body>
</html>
